# Исправление: "Проверить сейчас" после snooze не показывало окно

## Дата: 2025-11-27

## Проблема

После нажатия "Отложить" и последующей **ручной проверки** через "Проверить сейчас" в трее окно уведомления **не появлялось**.

### Логи показывали
```
17:20:01 check_now: snooze cleared, clearing Gmail cache
17:20:01 check_now: Gmail cache cleared
17:20:01 check_now: calling poll_once
17:20:01 poll_once: отправляем запрос в Gmail
17:20:04 poll_once: Gmail вернул 0 писем  ← Письма отфильтрованы как "известные"
```

## Причина

В функции `check_now()` при сбросе snooze мы:
1. ✅ Очищали кэш Gmail
2. ❌ **НЕ пытались показать текущее уведомление из очереди**
3. ❌ Делали запрос к Gmail, но все письма уже были в LRU кэше как "известные"
4. ❌ Gmail возвращал письма, но они отфильтровывались → 0 новых уведомлений

## Решение

Добавили в `check_now()` ту же логику, что и при автоматическом истечении snooze в `poll_once()`:

### Было
```rust
if was_snoozed {
    state.gmail.clear_cache();  // Только очистка кэша
}
state.poll_once(&app).await  // Сразу запрос к Gmail
```

### Стало
```rust
if was_snoozed {
    let settings = state.settings.get();
    
    // Сначала пытаемся показать текущее уведомление из очереди
    if let Ok(true) = state.notifier.replay_current(&app, &settings) {
        return Ok(());  // Уведомление показано, выходим
    }
    
    // Если уведомления нет, очищаем кэш
    state.gmail.clear_cache();
}
state.poll_once(&app).await
```

## Изменённые файлы

- `src-tauri/src/main.rs` — функция `check_now()`

## Ожидаемое поведение

### Сценарий 1: Автоматическое истечение snooze
1. Пользователь нажимает "Отложить"
2. Ждёт окончания времени
3. ✅ Окно появляется автоматически

### Сценарий 2: Ручная проверка во время snooze
1. Пользователь нажимает "Отложить"
2. Нажимает "Проверить сейчас" (не дожидаясь окончания)
3. ✅ Окно появляется немедленно (показывается из очереди)

### Сценарий 3: Повторный snooze
1. Пользователь нажимает "Отложить"
2. Ждёт окончания, окно появляется
3. Снова нажимает "Отложить"
4. Нажимает "Проверить сейчас"
5. ✅ Окно появляется (из очереди)

## Связанные файлы

- `docs/DEADLOCK_RESOLVED.md` — решение основного deadlock
- `docs/bugfixes.md` — общая документация багов

## Статус

✅ **ИСПРАВЛЕНО**
✅ **Собрано**
✅ **Готово к тестированию**

