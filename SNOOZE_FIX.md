# Исправление проблемы с функцией "Отложить"

## Проблема
При нажатии кнопки "Отложить" приложение переставало проверять почту даже при нажатии кнопки "Проверить сейчас" в трее или в настройках. Автоматическая проверка также не работала. Кроме того, уведомления не появлялись после нажатия "Проверить сейчас" во время режима отложения.

## Причины
1. Функция `snooze()` устанавливала таймер `snooze_until`, который блокировал все проверки почты в функции `poll_once()`
2. Функция `check_now()` не сбрасывала этот таймер, что приводило к блокировке проверки почты
3. При snooze очищалась очередь уведомлений (`notifier.clear()`), что приводило к потере информации о текущих непрочитанных письмах
4. Письма помечались как "seen" в кэше Gmail клиента, поэтому не показывались повторно

## Решение

### 1. Изменена логика функции `snooze()`
Теперь функция **НЕ** очищает очередь уведомлений, а только скрывает окно. Это позволяет сохранить информацию о непрочитанных письмах:

```rust
#[tauri::command]
async fn snooze(app: AppHandle, state: tauri::State<'_, AppState>) -> Result<(), String> {
    let duration_mins = state.settings.get().snooze_duration_mins;
    let duration = Duration::from_secs(duration_mins * 60);
    *state.snooze_until.lock() = Some(std::time::Instant::now() + duration);
    
    // Скрываем окно уведомления, но не очищаем очередь
    // Уведомления появятся снова после окончания snooze
    if let Some(win) = app.get_webview_window("alert") {
        let _ = win.hide();
    }
    Ok(())
}
```

### 2. Улучшена функция `check_now()`
Добавлен сброс режима отложения И показ текущего уведомления:

```rust
// Сбрасываем режим отложения при принудительной проверке
*state.snooze_until.lock() = None;

// Показываем текущее уведомление если оно было скрыто при snooze
if let Some(notification) = state.notifier.current() {
    if let Some(win) = app.get_webview_window("alert") {
        let _ = win.show();
        let _ = win.set_focus();
        let _ = app.emit("gmail://notification", &notification);
    }
}
```

### 3. Улучшена функция `poll_once()`
После истечения времени отложения автоматически показывается текущее уведомление:

```rust
if let Some(until) = *self.snooze_until.lock() {
    if std::time::Instant::now() < until {
        debug!("gmail polling snoozed");
        return Ok(());
    } else {
        *self.snooze_until.lock() = None;
        // После окончания snooze, показываем текущее уведомление если оно есть
        if let Some(notification) = self.notifier.current() {
            if let Some(win) = app.get_webview_window("alert") {
                let _ = win.show();
                let _ = win.set_focus();
                let _ = app.emit("gmail://notification", &notification);
            }
        }
    }
}
```

## Изменённые файлы
- `src-tauri/src/main.rs` - изменены функции `snooze()`, `check_now()` и `poll_once()`

## Как теперь работает
1. При нажатии "Отложить":
   - Окно уведомления скрывается
   - Устанавливается таймер snooze
   - Очередь уведомлений НЕ очищается
   - Проверки почты временно приостанавливаются

2. При нажатии "Проверить сейчас":
   - Режим отложения сбрасывается
   - Если есть непрочитанные письма в очереди, окно показывается
   - Выполняется проверка новых писем
   - Новые письма добавляются в очередь и показываются

3. После истечения времени отложения:
   - Режим отложения автоматически сбрасывается
   - Если есть непрочитанные письма в очереди, окно показывается автоматически
   - Проверки почты возобновляются по расписанию

## Тестирование
После применения исправления:
1. Получите уведомление о письме
2. Нажмите кнопку "Отложить" - окно должно скрыться
3. Нажмите "Проверить сейчас" в меню трея или в настройках - окно должно появиться с тем же письмом
4. Нажмите "Отложить" снова
5. Подождите окончания времени отложения - окно должно появиться автоматически

## Дата исправления
27.11.2025

