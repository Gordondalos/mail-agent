# Спецификация фичи: Трей-уведомитель почты (Gmail OAuth)

**Ветка фичи**: `001-gmail-oauth-notifier`  
**Создано**: 2025-10-24  
**Статус**: Черновик  
**Ввод**: Описание пользователя: "Мы пишем прилоежние которое будет проверять почту gmail и чуть позже вероятно дургие почты, это приложение при запуске должно сходить и авторизоваться через OAuth в гугле чтобы забирать почту и сохранить нужные кредиталы, приложение должно иметь конфиг где указывается логин пользователя, пароль если это необходимо, путь до мелодии котороую проиграть при получении почту, частата проверки почты. После того как все сконфигурирована почта должна проверяться и если есть новые письма показывать пользователю алерт размером 600 пикселей на 150 содержащие тайтл письма и кнопки просмотреть и пропустить, просмотр открывает браузер и навигируется к письму, пропустить помечает как прочитанное. Приложение пишется на таури, в качетсве фронтенда нужно использовать ангуляр последней версии с ангуляр материал. После запуска приложение просто висит в трее, при клике по иконке в трее есть меню которое содержит кнопку выйти и кнопку настройки, при выборе настроек отображаются все возможные настройки, приложение по умолчанию прописывается а атовзапуск, в настройках можно изменить это поведение"

## Уточнения (Clarifications)

### Сессия 2025-10-24

- Q: Политика аутентификации для провайдеров без OAuth? → A: OAuth везде, где доступно; для провайдеров без OAuth — пароль приложения (обычные пароли не поддерживаются).
- Q: Как обрабатывать несколько новых писем одновременно? → A: Показывать уведомления по одному (очередь).
- Q: Автоскрытие уведомления? → A: Не автоскрывать; только по действию пользователя («Просмотреть»/«Пропустить»).

## Пользовательские сценарии и тестирование (обязательно)

### Сценарий 1 — Подключение аккаунта и настройки (Приоритет: P1)

Пользователь подключает почтовый аккаунт и настраивает предпочтения уведомлений.

**Почему этот приоритет**: Без подключения и базовых настроек продукт не
приносит ценности.

**Независимый тест**: Новый пользователь завершает подключение аккаунта, задаёт
интервал опроса и путь к звуку, затем успешно сохраняет настройки.

**Критерии приемки**:

1. При первом запуске без подключённого аккаунта, когда пользователь выбирает
   «Войти» в приложении, запускается авторизация; по завершении аккаунт
   отображается как подключённый в настройках.
2. При открытых настройках, когда пользователь задаёт частоту опроса и выбирает
   валидный звуковой файл, то сохранение фиксирует значения и они сохраняются
   после перезапуска приложения.

---

### Сценарий 2 — Уведомления о новых письмах (Приоритет: P2)

Пользователь получает уведомления о новых непрочитанных письмах в виде
компактного оверлея на экране.

**Почему этот приоритет**: Своевременные уведомления — ключевая ценность
продукта.

**Независимый тест**: При подключённом аккаунте и настройках по умолчанию,
появление нового непрочитанного письма вызывает показ оверлея с корректным
содержимым и действиями.

**Критерии приемки**:

1. При подключённом аккаунте и запущенном приложении в фоне, когда приходит
   новое непрочитанное письмо, появляется оверлей размером 800×150 пикселей с
   темой письма и кнопками «Просмотреть» и «Пропустить».
2. Когда оверлей видим, при нажатии «Просмотреть» открывается браузер с
   соответствующим письмом.
3. Когда оверлей видим, при нажатии «Пропустить» письмо помечается как
   прочитанное, а оверлей закрывается.
4. Когда оверлей видим и пользователь не предпринимает действий, оверлей
   остаётся на экране до выбора «Просмотреть» или «Пропустить» (без
   автоскрытия).

---

### Сценарий 3 — Меню трея и автозапуск (Приоритет: P3)

Пользователь управляет приложением из системного трея и настраивает автозапуск.

**Почему этот приоритет**: Улучшает удобство и контроль без прерывания
рабочего процесса.

**Независимый тест**: В меню трея есть «Настройки» и «Выход». Автозапуск по
умолчанию включён и может быть отключён в настройках.

**Критерии приемки**:

1. При запущенном приложении при клике по иконке в трее появляется меню с
   пунктами «Настройки» и «Выход».
2. После установки при следующем старте системы приложение запускается
   автоматически, если пользователь не отключил автозапуск в настройках.
3. Если автозапуск включён, то после его отключения в настройках приложение не
   стартует автоматически при следующем запуске системы.

---

### Краевые случаи

- Нет сети во время авторизации или опроса.
- Истечение или отзыв токена; требуется повторная аутентификация.
- Несколько писем между интервалами опроса: уведомления выстраиваются в очередь
  и показываются по одному; новые письма добавляются в очередь.
- Не задан браузер по умолчанию или невозможно открыть ссылку на письмо.
- Некорректный путь/формат звукового файла.
- Пользователь отключил автозапуск, но ожидает уведомления после перезагрузки.
- Пользователь отошёл: оверлей остаётся до действия (задумано; без
  автоскрытия).

## Требования (обязательно)

### Функциональные требования

- **FR-001**: Система ДОЛЖНА инициировать авторизацию почтового аккаунта при
  первом запуске или при отсутствии/некорректности учётных данных.
- **FR-002**: Учётные данные/токены ДОЛЖНЫ храниться безопасно и не попадать в
  вывод/логи. Хранение обычных паролей запрещено. Политика провайдеров: при
  наличии использовать OAuth; если у провайдера нет OAuth — поддерживать пароли
  приложений; обычные пароли не поддерживаются.
- **FR-003**: Система ДОЛЖНА предоставить настройки: частота опроса, путь к
  звуковому файлу, переключатель автозапуска. Поля логин/пароль отображать
  ТОЛЬКО если выбранный провайдер требует пароля приложения.
- **FR-004**: Система ДОЛЖНА периодически опрашивать подключённый аккаунт на
  наличие новых непрочитанных писем с заданным интервалом.
- **FR-005**: При обнаружении новых писем система ДОЛЖНА показывать оверлей
  800×150 пикселей с темой письма и действиями «Просмотреть» и «Пропустить».
- **FR-006**: При выборе «Просмотреть» ДОЛЖЕН открываться браузер по умолчанию
  на странице соответствующего письма/треда.
- **FR-007**: При выборе «Пропустить» письмо ДОЛЖНО помечаться прочитанным, а
  оверлей — закрываться.
- **FR-008**: Приложение ДОЛЖНО работать в системном трее и иметь меню с
  пунктами «Настройки» и «Выход».
- **FR-009**: Автозапуск ДОЛЖЕН быть включён по умолчанию и управляться через
  настройки.
- **FR-010**: При множественных новых письмах система ДОЛЖНА выстраивать их в
  очередь и показывать по одному до опустошения очереди.
- **FR-011**: Оверлей уведомления НЕ ДОЛЖЕН автоскрываться; остаётся видимым до
  выбора пользователем «Просмотреть» или «Пропустить».

### Ключевые сущности (если есть данные)

- **Account**: адрес почты пользователя и тип провайдера.
- **Credential**: безопасная ссылка на токены/секреты авторизации.
- **Settings**: интервал опроса, путь к звуку, переключатель автозапуска и
  провайдер-специфичные поля.
- **Email Item**: идентификатор, тема/subject и глубокая ссылка для открытия в
  браузере.
- **Notification**: экземпляр оверлея, связанный с конкретным Email Item.

## Критерии успеха (обязательно)

### Измеримые результаты

- **SC-001**: Новые пользователи завершают подключение и сохраняют настройки
  менее чем за 3 минуты без помощи.
- **SC-002**: При наличии сети и интервале по умолчанию (например, 60с) 95% новых
  непрочитанных писем вызывают показ оверлея в течение 5 секунд после следующего
  цикла опроса.
- **SC-003**: 95% действий «Просмотреть» успешно открывают соответствующее
  письмо в браузере по умолчанию.
- **SC-004**: 95% действий «Пропустить» приводят к пометке письма как прочитанного
  в пределах одного цикла опроса.
- **SC-005**: Пользователь может включить/выключить автозапуск и наблюдает
  ожидаемое поведение при следующем старте системы.
