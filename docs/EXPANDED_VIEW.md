# Функционал развёрнутого просмотра письма

**Дата:** 2025-11-27  
**Статус:** Реализовано

## Описание

Добавлен функционал двойного клика по окну уведомления для разворачивания его до полного размера с отображением содержимого письма.

## Внесенные изменения

### 1. Backend (Rust)

#### Структура настроек (config.rs)
- **Добавлены поля:**
  - `notification_expanded_width: u32` - ширина развёрнутого окна (по умолчанию: 800px)
  - `notification_expanded_height: u32` - высота развёрнутого окна (по умолчанию: 600px)
- **Валидация:**
  - Ширина: от 400 до 1920px
  - Высота: от 300 до 1080px

#### Получение содержимого письма (gmail.rs)
- **Структура GmailNotification:**
  - Добавлено поле `body: Option<String>` - HTML или текстовое содержимое письма
  
- **Изменён метод fetch_message:**
  - Изменён формат запроса с `metadata` на `full` для получения полного содержимого
  - Добавлены структуры для парсинга MIME-частей письма:
    - `MessagePart` - часть MIME-сообщения
    - `MessageBody` - тело части сообщения
  
- **Добавлены функции обработки:**
  - `extract_body()` - извлечение тела письма (приоритет: HTML → plain text)
  - `find_part_by_mime()` - рекурсивный поиск части по MIME-типу
  - `decode_body()` - декодирование URL-safe Base64 содержимого

### 2. Frontend (Angular)

#### Компонент уведомлений (notification-overlay.ts)
- **Добавлено:**
  - Поле `body` в тип `NotificationPayload`
  - Signal `isExpanded` для отслеживания состояния окна
  - Метод `toggleExpand()` для переключения между обычным и развёрнутым видом

- **Логика toggleExpand():**
  ```typescript
  async toggleExpand() {
    if (!isCurrentlyExpanded) {
      // Разворачиваем до настроенных размеров
      await window.setSize({ 
        width: settings.notification_expanded_width ?? 800,
        height: settings.notification_expanded_height ?? 600
      });
    } else {
      // Сворачиваем обратно
      await window.setSize({
        width: settings.notification_width ?? 650,
        height: settings.notification_height ?? 150
      });
    }
  }
  ```

#### Шаблон (notification-overlay.component.html)
- **Добавлено:**
  - Обработчик `(dblclick)="toggleExpand()"` на корневой элемент
  - Условное отображение snippet только в свёрнутом виде
  - Блок `.alert-body` для отображения HTML-содержимого письма в развёрнутом виде
  - Использование `[innerHTML]` для безопасного рендеринга HTML

#### Стили (notification-overlay.component.scss)
- **Исправлено:**
  - Убран `margin-left: 12px` у `.alert-recipient` (поле "Кому:")
  
- **Добавлено:**
  - Стили для `.alert-body`:
    - Прокрутка по вертикали (`overflow-y: auto`)
    - Максимальная высота с учетом viewport
    - Фоновый цвет и закругление углов
    - Стилизация вложенного HTML-содержимого:
      - Ограничение ширины изображений
      - Стили для ссылок
      - Стили для таблиц и цитат

#### Страница настроек (settings-page)
- **Добавлено:**
  - Секция "Размеры развёрнутого окна (двойной клик)"
  - Поля ввода:
    - "Ширина развёрнутого окна (px)" - от 400 до 1920
    - "Высота развёрнутого окна (px)" - от 300 до 1080
  - Обработка новых полей при сохранении настроек

## Использование

1. **Просмотр уведомления:**
   - При получении нового письма появляется компактное уведомление с краткой информацией

2. **Развёртывание:**
   - Двойной клик по любой части окна уведомления разворачивает его
   - В развёрнутом виде отображается полное содержимое письма (HTML или текст)
   - Письма с HTML корректно отображаются со всеми стилями и изображениями

3. **Свёртывание:**
   - Повторный двойной клик сворачивает окно обратно в компактный вид

4. **Настройка размеров:**
   - В настройках можно указать желаемые размеры развёрнутого окна
   - Изменения применяются при следующем развёртывании

## Технические детали

### Декодирование содержимого Gmail
Gmail API возвращает содержимое писем в формате URL-safe Base64:
- Симво��ы `-` заменяются на `+`
- Символы `_` заменяются на `/`
- Затем применяется стандартное деко��ирование Base64

### Приоритет форматов
При извлечении содержимого письма применяется следующий приоритет:
1. HTML версия (`text/html`)
2. Plain text версия (`text/plain`)
3. Body непосредственно в payload

### Безопасность
- HTML содержимое рендерится через Angular's `[innerHTML]`, который автоматически санирует опасный код
- Изображения ограничены по ширине для предотвращения выхода за границы окна

## Исправленные проблемы

1. ✅ **HTML entities в полях "От:" и "Кому:"**
   - Угловые скобки теперь корректно отображаются через метод `decodeHtmlEntities()`
   - Пример: `John Doe <john@example.com>` вместо `John Doe &lt;john@example.com&gt;`

2. ✅ **Отступ у поля "Кому:"**
   - Убран лишний `margin-left: 12px`, теперь поле выровнено с "От:"
   - Поля "От:" и "Кому:" имеют одинаковое выравнивание по левому краю

3. ✅ **Отображение содержимого письма**
   - Реализована полная поддержка HTML и текстовых писем
   - Добавлены стили для корректного отображения различных элементов
   - Содержимое письма извлекается из Gmail API с автоматическим декодированием Base64

## Настройки по умолчанию

```rust
notification_width: 650,              // Обычная ширина
notification_height: 150,             // Обычная высота
notification_expanded_width: 800,     // Развёрнутая ширина
notification_expanded_height: 600,    // Развёрнутая высота
```

## Возможные улучшения

- [ ] Добавить кнопку развёртывания/свёртывания (помимо двойного клика)
- [ ] Запоминать состояние развёрнутости между уведомлениями
- [ ] Добавить анимацию при изменении размера окна
- [ ] Поддержка вложений (attachments)
- [ ] Предпросмотр изображений в полном размере

