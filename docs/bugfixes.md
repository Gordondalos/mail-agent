# Исправленные баги

## 2025-11-27: Функция "Отложить" не работала (v3 - DEADLOCK УСТРАНЕН)

### Симптомы
- После нажатия кнопки "Отложить" приложение полностью переставало проверять почту
- Кнопка "Проверить сейчас" в трее не работала
- Уведомления не появлялись после окончания snooze
- В логах выполнение останавливалось после `"snooze expired"` или `"check_now: manual check requested"`
- **Код зависал (deadlock)** при попытке показать уведомление

### Причины (итоговый анализ)
1. **Обработчик трея вызывал неправильную функцию**: `poll_once()` вместо `check_now()`
2. **Конфликт имен**: Переменная `check_now` (MenuItem) затеняла функцию `check_now()`
3. **Функция snooze() очищала очередь уведомлений**
4. **ГЛАВНАЯ ПРОБЛЕМА: Deadlock на мьютексе** - вызов `notifier.current()` блокировал мьютекс, который уже был заблокирован

### Окончательное решение

**Проблемный код (вызывал deadlock):**
```rust
if let Some(notification) = self.notifier.current() {  // ← DEADLOCK!
    self.gmail.forget(&notification.id);
}
```

**Рабочее решение:**
```rust
self.gmail.clear_cache();  // ← Очищаем весь кэш Gmail, нет мьютексов!
```

### Исправления
1. Переименована переменная `check_now` → `check_now_item` в `register_tray()`
2. Обработчик трея вызывает функцию `check_now()` вместо `poll_once()`
3. Функция `snooze()` не очищает очередь уведомлений
4. **Добавлен новый метод `clear_cache()` в GmailClient**
5. **Убраны все вызовы `notifier.current()`** - они вызывали deadlock
6. После snooze/при "Проверить сейчас" очищается весь кэш Gmail
7. Добавлено подробное логирование
8. Добавлены npm скрипты `rebuild` и `run:dev`

### Затронутые файлы
- `src-tauri/src/main.rs` - функции `poll_once()`, `check_now()`, `snooze()`, `register_tray()`
- `src-tauri/src/gmail.rs` - добавлен метод `clear_cache()`
- `package.json` - добавлены npm скрипты

### Как работает сейчас

**При нажатии "Отложить":**
1. Окно скрывается
2. Устанавливается таймер snooze
3. Очередь уведомлений сохраняется

**После окончания snooze:**
1. Таймер сбрасывается
2. **Очищается ВЕСЬ кэш Gmail** (`clear_cache()`)
3. Выполняется обычная проверка почты
4. Gmail возвращает ВСЕ непрочитанные письма
5. Письма добавляются в очередь через `notifier.enqueue()`
6. Окно уведомления появляется через стандартный механизм

**При нажатии "Проверить сейчас":**
1. Таймер snooze сбрасывается
2. Очищается кэш Gmail
3. Выполняется проверка почты
4. Уведомления появляются

### Преимущества решения
- ✅ **Нет deadlock** - не используем `notifier.current()`
- ✅ **Простота** - один вызов `clear_cache()`
- ✅ **Надежность** - независимые компоненты
- ✅ **Эффективность** - очищает весь кэш за O(1)

### Статус
✅ **Deadlock устранен**
✅ **Код упрощен**
✅ **Готово к тестированию**

### Быстрая пересборка
```powershell
npm run rebuild    # Пересобрать
npm run run:dev    # Запустить
```

Подробнее: [DEADLOCK_FIX_COMPLETE.md](../DEADLOCK_FIX_COMPLETE.md)

