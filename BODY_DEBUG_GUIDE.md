# Отладка получения тела письма

## Текущий статус

Я добавил детальное логирование в код получения тела письма:

### Изменения в `gmail.rs`:

1. **В `fetch_message`**: Добавлено логирование структуры полученного сообщения
   - Количество частей в payload
   - Наличие body в payload
   - Для каждой части: mime_type, наличие body, количество вложенных частей

2. **В `extract_body`**: Добавлено логирование процесса извлечения
   - Структура всех частей
   - Результаты поиска HTML и plain text версий
   - Попытка использовать body из payload

3. **В `find_part_by_mime`**: Улучшена логика поиска
   - Приоритетная обработка multipart контейнеров
   - Проверка наличия данных перед возвратом
   - Детальное логирование каждого шага

4. **В `decode_body`**: Логирование процесса декодирования
   - Наличие data
   - Длина закодированных данных
   - Результат декодирования

## Следующие шаги для тестирования

1. Запустите приложение:
   ```powershell
   .\test-body.ps1
   ```

2. Подождите, пока придёт новое письмо или нажмите "Check Now" в меню трея

3. Изучите логи в консоли - ищите строки начинающиеся с:
   - `fetch_message:` - структура полученного сообщения
   - `extract_body:` - процесс извлечения тела
   - `find_part_by_mime:` - поиск частей по MIME типу
   - `decode_body:` - декодирование Base64

4. Когда появится уведомление, сделайте двойной клик для разворачивания окна

5. Проверьте, отображается ли тело письма

## Возможные проблемы и решения

### Проблема 1: Gmail API не возвращает body.data

**Признак**: В логах `find_part_by_mime: длина data=0` или `data.is_some=false`

**Причина**: Gmail API может не возвращать содержимое для некоторых типов писем или больших писем

**Решение**: Нужно добавить поддержку `attachmentId` для получения содержимого отдельным запросом

### Проблема 2: Неправильная структура multipart

**Признак**: В логах видно, что есть части, но они не находятся

**Причина**: Сложная вложенная структура multipart/alternative внутри multipart/mixed

**Решение**: Улучшить рекурсивный поиск (уже сделано в текущей версии)

### Проблема 3: Неправильное декодирование

**Признак**: `decode_body: результат декодирования = false`

**Причина**: Неправильный формат Base64 или кодировка

**Решение**: Проверить и исправить функцию декодирования

## Что смотреть в логах

Пример успешного извлечения:
```
fetch_message: получено сообщение id=..., payload.parts.len=2
extract_body: начало извлечения тела письма
extract_body: количество частей = 2
find_part_by_mime: ищем тип text/html
find_part_by_mime: найдено тело для типа text/html, data.is_some=true
find_part_by_mime: длина data=1234
decode_body: начало декодирования, есть ли data = true
decode_body: длина закодированных данных = 1234
decode_body: декодировано 987 байт
decode_body: результат декодирования = true
extract_body: HTML декодирован, результат = true
into_notification: тело письма извлечено, есть ли body = true
into_notification: длина тела = 987
```

Пример неудачного извлечения:
```
fetch_message: получено сообщение id=..., payload.parts.len=1
extract_body: начало извлечения тела письма
extract_body: количество частей = 1
find_part_by_mime: ищем тип text/html
find_part_by_mime: тип text/html не найден
find_part_by_mime: ищем тип text/plain
find_part_by_mime: тип text/plain не найден
extract_body: тело письма не найдено
into_notification: тело письма извлечено, есть ли body = false
```

